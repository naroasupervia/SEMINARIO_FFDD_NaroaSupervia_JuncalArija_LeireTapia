---
title: "Datos suicidio"
author: "Juncal Arija, Naroa Supervia, Leire Tapia"
date: "2025-11-06"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **INTRODUCCIÓN**
contextualiza la idea del seminario, entrega una idea general de la temática, de lo que se sabe y sobre todo de lo que no se sabe y queréis abordar en vuestro trabajo.

El suicidio es un fenómeno ocmplejo que constituye un importante problema de salud pública en España y en el mundo. Aunque se dispone de información general sobre la mortalidad por suicidio, la evidencia científica revela diferencias significativas según el sexo, la edad y el territorio.

En este seminario, nos proponemos comparar el suicidio utilizando distintos conjuntos de datos (sexo, edad y territorio) para explorar las diferencias y analizar a que se deben.



# **OBJETIVOS** 
1. Describir la distribución del suicidio por sexo en España. 

2. Analizar las diferencias entre provincias. 

3. Estudiar la influencia del grupo de edad en la cantidad de suicidios. 

4. Unificar los datos CSV y JSON para obtener una vista más completa. 

5. (Opcional) Explorar si existe relación entre grupos de edad + provincias + sexo. 



# **PAQUETES UTILIZADOS**
Para poder utilizar nuestros conjuntos de datos es necesario importar las siguientes librerias y paquetes:

```{r , eval = TRUE,message=FALSE, warning=FALSE}
# Datos con formato .csv:
library(readr)

#Datos con formato .json:
library(tidyverse)
library(rjson)
library(jsonlite)
library(tidyjson)

#Visualizacion resultados:
library(DT)
library(ggplot2)
library(gifski)
library(gganimate)
library(plotly)
library(dplyr)
library(mapSpain)
library(knitr) # librería para tablas 
```



# **DESARROLLO Y RESULTADOS**
Una vez cargadas las librerias importamos los datos

## OBTENCIÓN DE LOS DATOS 
Para este trabajo se han utilizado dos conjuntos de datos procedentes del Instituto Nacional de Estadísitca (INE), a través de sus estadísticas oficiales sobre defunciones según causa de muerte. Ambas fuentes se han descargado directamente desde la herramienta de consulta del INE y contienen información actualizada y validada por el organismo. 

- **provincias_sexo.csv**: Este archivo recoge la tasa de suicidios por cada 100.000 habitantes en Esapaña, desglosada por: provincia, sexo (total, hombes, mujeres) y año (2021, 2022 y 2023). 
Cada fila representa la tasa correspondiente a un territorio y un sexo concreto en un año determinado.
Estos valores provienen directamente el INE y reflejan las tasas oficiales calculadas del instituto, basadas en la población residente de cada año. 
Este archivo le hemos utilizado para:
  - Analizar la evolución reciente (2021 - 2023) 
  - Las diferencias entre sexos 
  - Las variaciones territoriales entre provincias.

- **suicidio_Edad-Sexo.json**: Este JSON  contiene el número absoluto de suicidios registrados a nivel nacional en el año 2022 (creemos). Está desglosado por grupo de edad y por sexo. 
La estructura del Json incluye:
  - Un campo MetaData, donde se especifíca el sexo y el grupo de edad.
  - Un campo Data, donde aparece el valor numérico de suicidios en ese grupo.
Estos datos también han sido descargados del INE y corresponden al mismo sistema estadístico, pero en este caso sin convertirlos en tasas, es decir, son numéros absolutos de casos, no tasas de población.
Este archivo se ha empleado para:
  - Calcular los suicidios totales por sexo
  - Relacionar los valores con la población para obtener tasas a medida
  - Analizar diferencias entre grupos de edad
  
En resumen, el CSV ofrece tasas por provincia, sexo y año, mientras que el JSON proporciona números absolutos por edad y sexo a nivel nacional. Esta combinación permite un análisis estadístico completo tanto a nivel territorial como demográfico. 


## IMPORTACIÓN DE LOS DATOS

### **IMPORTACIÓN DATOS CSV**
En algunos de nuestros archivos csv, es necesario especificar el tipo de codificación que tienen, para que R pueda leer correctamente los caracteres especiales como *tildes* o *ñ*. En nuestro caso utilizan la codificacion *ISO 8859-1* que corresponde con el alfabeto español??? :

```{r , eval = TRUE,message=FALSE}

# Para conocer el tipo de codificación: 
encoding <- guess_encoding("INPUT/DATA/provincias_sexo.csv")
print(encoding)

```

```{r , eval = TRUE,message=FALSE}

provincias <- read_delim("INPUT/DATA/provincias_sexo.csv", 
                         delim = ";", trim_ws = TRUE, 
                         locale = locale(encoding = "ISO-8859-1"),
                         # FORZAMOS QUE TODO SE LEA COMO TEXTO AL PRINCIPIO
                         col_types = cols(.default = "c"))
head(provincias)
```
### IMPORTACIÓN DEL JSON


```{r , eval = TRUE,message=FALSE}

# Ruta al archivo JSON
ruta_json <- "INPUT/DATA/Suicidio_Edad-Sexo.json"

# Importar JSON y convertir a dataframe
suicidios_json <- fromJSON(ruta_json)
#suicidios_json <- as.data.frame(suicidios_json)

# Mostrar las primeras filas
head(suicidios_json)

```

## FILTRADO Y PREPARACIÓN DE LOS DATOS
Los datos han sido filtrados y preparados para asegurar la coherencia entre las fuentes. Se eliminaron los totales generales en sexo para poder comparar hombres y mujeres. Se normalizó el nombre de las provincias para ....noseq
y se separó el json en edad, sexo y valor para noseqqq

### Convertir la columna 'Total' del CSV de texto a número
```{r , eval = TRUE,message=FALSE}
provincias <- provincias %>%
  mutate(
    # Ahora 'Total' es texto seguro (ej: "13,34").
    # Cambiamos la coma por punto.
    Total = as.numeric(gsub(",", ".", Total)),
    # Aprovechamos para convertir 'Periodo' a número también
    Periodo = as.numeric(Periodo)
  )

# Ahora creamos el dataframe filtrado
Suicidios_CSV_filtrado <- provincias %>%
  filter(Sexo != "Total", 
         Provincias != "Nacional")

# Verificamos: Total debe ser <dbl> (número real con decimales)
head(Suicidios_CSV_filtrado)
```


### Normalizar nombres de provincias (quitar tildes, ñ o cosas q hagan q los nombres se vean mal)
```{r , eval = TRUE,message=FALSE}
# Crear el dataframe filtrado para el gráfico
# (Usa el dataframe 'provincias' que ya cargaste y mutaste)
Suicidios_CSV_filtrado <- provincias %>%
  filter(Sexo != "Total", 
         Provincias != "Nacional")

# Ver el resultado (opcional)
head(Suicidios_CSV_filtrado)
```

### Eliminar "total" en sexo
Para así comparar hombres vs mujeres 
(entonces yo quitaría lo de cambiar el separador decimal xq si quitamos el total no nos hace falta camibar lo de . por , nose)

```{r , eval = TRUE,message=FALSE}
library(dplyr)
library(purrr)
library(tidyr)

# ===============================
# 1. Provincias: eliminar "Total" en Sexo
# ===============================
provincias_filtrado <- provincias %>%
  filter(Sexo != "Total")

# Revisar resultado
head(provincias_filtrado)
```


### El JSON:separar edad y sexo
Extraer:
- Lista de edades
- Lista de sexos
- Valor 
```{r , eval = TRUE,message=FALSE}
# Chunk CORREGIDO para: ### El JSON:separar edad y sexo
# (Asegúrate de tener 'library(tidyverse)' y 'library(jsonlite)' en tu chunk de paquetes)

# Este código usa un método más robusto para "aplanar" el JSON
# y evitar que se creen valores NA.

Suicidios_Edad <- as_tibble(suicidios_json) %>%
  
  # 1. Extraer el 'Valor' de la sub-lista 'Data'
  #    (map_dbl toma cada elemento de 'Data' y extrae el primer 'Valor')
  mutate(Valor = map_dbl(Data, ~ .x$Valor[1])) %>%
  
  # 2. Guardar el 'Nombre' original (ej. "De 15 a 29 años, Hombres")
  #    como un ID único para agrupar las filas.
  select(ID_Fila = Nombre, Valor, MetaData) %>%
  
  # 3. Desanidar 'MetaData', que creará dos filas por cada ID_Fila
  #    (una para 'edad' y otra para 'sexo')
  unnest(MetaData) %>%
  
  # 4. Seleccionar solo las columnas que necesitamos para pivotar
  select(ID_Fila, Valor, T3_Variable, Nombre) %>%

  # 5. Pivotar usando el ID_Fila. Esto asegura que la 'edad' y el 'sexo'
  #    del mismo ID_Fila terminen en la misma fila, junto a su 'Valor'.
  pivot_wider(names_from = T3_Variable, values_from = Nombre) %>%
  
  # 6. Filtrar los totales (como antes)
  filter(sexo != "Ambos sexos",
         edad != "Todas las edades") %>%
  
  # 7. (Opcional) Quitar la columna de ID, ya no la necesitamos
  select(edad, sexo, Valor)

# Ver el resultado (opcional)
# Esta tabla ya no debería tener NAs en 'edad' o 'sexo'
print("Datos JSON (versión final) listos:")
head(Suicidios_Edad)
```

## RESULTADOS 
Aquí vienen los gráficos 

### Suicidio por sexo a nivel nacional
Usando los datos del JSON, a partir de la tabla Suicidios_Edad (con las columnas sexo, edad y valor), agrupamos los datos que tengan el mismo valor en la columna sexo (hombres/mujeres) y para cada grupo hemos calculado la suma total de la columna valor. Como resultado obtenemos un nuevo tibble de 2 filas (una por sexo), con las columnas sexo y total.
Con el nuevo tibble creamos un gráfico de barras.
```{r , eval = TRUE,message=FALSE}
# Sumar los valores por sexo
suicidio_sexo_nacional <- Suicidios_Edad %>%
  group_by(sexo) %>%
  summarise(Total = sum(Valor, na.rm = TRUE))

# Revisar tabla
print(suicidio_sexo_nacional)

# #GRAFICO DE BARRAS (suicidios por sexo a nivel nacional)
ggplot(suicidio_sexo_nacional, aes(x = sexo, y = Total, fill = sexo)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Suicidios por sexo a nivel nacional",
    x = "Sexo",
    y = "Número total de suicidios"
  ) +
  scale_fill_manual(values = c("Hombres" = "#1f77b4", "Mujeres" = "#ff7f0e")) +
  theme_minimal()
```

Podemos representar los datos anteriores en otros tipos de gráfico, por ejemplo el gráfico circular.
Igual que en el anterior, agrupamos los datos que tengan el mismo valor en la columna sexo, y para cada grupo calculamos la suma total de la columna valor, obteniendo como resultado un nuevo tibble para llevar a cabo el gráfico circular.
```{r , eval = TRUE,message=FALSE}
# 1. Filtrar datos a nivel nacional (ya que JSON tiene solo sexo y edad, sumamos por sexo)
nacional_sexo <- Suicidios_Edad %>%
  group_by(sexo) %>%
  summarise(Total = sum(Valor))

print(nacional_sexo) #visualizamos el nuevo tibble

#GRÁFICO CIRCULAR
ggplot(nacional_sexo, aes(x = "", y = Total, fill = sexo)) +
  geom_bar(stat = "identity", width = 1) +   # barra para convertir a circular
  coord_polar(theta = "y") +                 # transforma a circular
  labs(title = "Suicidios por sexo a nivel nacional") +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  scale_fill_manual(values = c("Hombres" = "steelblue", "Mujeres" = "pink"))
```  

INTERPRETACIÓN
El gráfico de barras compara el total de suicidios entre hombres y mujeres, muestra que los hombreses presentan un mayor número de suicidios. El gráfico circular representa la misma información, pero en proporciones del total, muestra que los hombres representan aproximadamente el 75% de los suicidios a nivel nacional, mientras que las mujeres el 25%. 

En conclusión, los análisis del total de suicidios según el sexo muestra una diferencia clara entre hombres y mujeres.
En España, el número total de suicidios es significativamente mayor en hombres que en mujeres, lo cual coincide con las estadísitcas nacionales e internacionales, donde los hombres presentan tasas de suicidio más elevadas a pesar de que las mujeres registran más intentos no letales.
Este patrón puede estar asociado a factores socioculturales, diferencias en métodos utilizados, menor búsqueda de ayuda por parte de los hombres o barreras sociales relaccionadas con la salud mental.

### Suicidio por provincia
### Suicidio por provincia
```{r , eval = TRUE,message=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(plotly)
library(scales) 
library(stringr) 

# Evitar notación científica en la visualización
options(scipen = 999) 

# 1. Limpieza y filtrado
Suicidios_CSV_filtrado_FINAL <- provincias %>%
  filter(Sexo != "Total",
         Provincias != "Nacional") %>%
  mutate(
    # Eliminar código numérico inicial (ej: "01 " de "01 Araba/Álava")
    Nombre_Limpio = str_remove(Provincias, "^\\d{1,2}\\s"),
    
    # Normalización de nombres (bilingües y capitalización)
    Nombre_Final = case_when(
        str_detect(Nombre_Limpio, "Alacant/Alicante") ~ "Alicante",
        str_detect(Nombre_Limpio, "Castelló/Castellón") ~ "Castellón",
        str_detect(Nombre_Limpio, "València/Valencia") ~ "Valencia",
        str_detect(Nombre_Limpio, "Araba/Álava") ~ "Álava", 
        str_detect(Nombre_Limpio, "Balears, Illes") ~ "Baleares",
        str_detect(Nombre_Limpio, "A Coruña") ~ "A Coruña",
        # Convertir el resto a formato Título (primera mayúscula, resto minúscula)
        TRUE ~ str_to_title(tolower(Nombre_Limpio))
    )
  )

# 2. Creación del gráfico estático
p <- ggplot(Suicidios_CSV_filtrado_FINAL, aes(x = Sexo, y = Total, color = Sexo)) + 
  geom_point(size = 3, alpha = 0.8) + 
  facet_wrap(~Nombre_Final, ncol = 6) + 
  labs(
    title = "Tasa de Suicidio por Provincia y Sexo (2021-2023)",
    subtitle = "Tasa por 100.000 habitantes. Se excluye el dato nacional.",
    x = "Sexo",
    y = "Tasa Total (x 100.000 hab.)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0), 
    strip.text = element_text(size = 7),
    legend.position = "bottom"
  ) +
  # Formato de ejes con coma decimal
  scale_y_continuous(labels = label_number(big.mark = ".", decimal.mark = ","))

# 3. Conversión a interactivo y ajuste final
p_plotly <- ggplotly(p)

# Ajuste de formato numérico en los tooltips de Plotly
p_plotly <- p_plotly %>%
  layout(yaxis = list(tickformat = ",.1f", 
                      hoverformat = ",.3f" 
                      ))

p_plotly
```
INTERPRETACIÓN: 
Aquí tienes la interpretación condensada en un solo párrafo:

El gráfico visualiza la tasa de suicidio por provincia y sexo en España durante el periodo 2021-2023, evidenciando una drástica y generalizada brecha de género en todo el territorio nacional. Los datos revelan que la mortalidad es sistemáticamente superior en los hombres (puntos rosas), cuyas tasas oscilan frecuentemente entre los 10 y más de 20 casos por cada 100.000 habitantes, mientras que las cifras en mujeres (puntos azules) se mantienen significativamente más bajas y estables, situándose casi siempre por debajo de 10. Este patrón estructural se repite en todas las provincias sin excepción, aunque se observa una incidencia masculina particularmente elevada en regiones del noroeste como Asturias, Lugo y Ourense, así como en zonas del interior como Zamora, donde la agrupación vertical de los puntos refleja las variaciones anuales ocurridas durante este trienio.
###Mapa interactivo

### MAPA INTERACTIVO DE SUICIDIO POR PROVINCIA
```{r , eval = TRUE, message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(plotly)
library(mapSpain)
library(stringr)
library(scales)

# 1. Lectura y limpieza inicial de datos
provincias_raw <- read_delim("INPUT/DATA/provincias_sexo.csv",
                             delim = ";", trim_ws = TRUE,
                             locale = locale(encoding = "ISO-8859-1"),
                             show_col_types = FALSE)

provincias_raw$Total <- as.numeric(gsub(",", ".", provincias_raw$Total))
provincias_raw$Periodo <- as.numeric(provincias_raw$Periodo)

# 2. Agregación y preparación de códigos
datos_mapa <- provincias_raw %>%
  filter(Sexo != "Total", Provincias != "Nacional") %>%
  mutate(
    # Extraemos los dos primeros dígitos para obtener el código INE
    cod_join = str_sub(Provincias, 1, 2)
  ) %>%
  group_by(cod_join) %>%
  summarise(
    Tasa_Media = mean(Total, na.rm = TRUE),
    Nombre_Provincia_Original = first(Provincias), 
    .groups = 'drop'
  )

# 3. Descargar geometría y unir datos
mapa_provincias <- esp_get_prov_siane(resolution = 10)

# Unimos usando 'cpro' (código INE en mapSpain) y nuestro 'cod_join'
mapa_datos <- mapa_provincias %>%
  mutate(cpro_join = as.character(cpro)) %>%
  left_join(datos_mapa, by = c("cpro_join" = "cod_join"))

# 4. Crear el gráfico Choropleth interactivo
p_mapa <- ggplot(mapa_datos) +
  geom_sf(aes(fill = Tasa_Media, 
              text = paste("Provincia:", str_remove(Nombre_Provincia_Original, "^\\d{1,2}\\s"), 
                           "<br>Tasa Media (x 100k):", format(Tasa_Media, big.mark = ".", decimal.mark = ","))
              )) +
  scale_fill_gradient(
    low = "#fef0d9",  
    high = "#b30000", 
    name = "Tasa Media (x 100k hab.)",
    labels = label_number(big.mark = ".", decimal.mark = ",") 
  ) +
  labs(
    title = "Tasa Media de Suicidio por Provincia (2021-2023)",
    caption = "Fuente: INE."
  ) +
  theme_void() + 
  theme(legend.position = "bottom")

# Convertir a Plotly para interactividad
ggplotly(p_mapa, tooltip = "text")
```
INTERPRETACIÓN:
Este mapa de calor ilustra la distribución geográfica de la tasa media de suicidio en España entre 2021 y 2023, revelando una clara concentración territorial del fenómeno en el noroeste peninsular. La provincia de Lugo se destaca visualmente como el foco de mayor incidencia, marcada con el tono rojo más intenso que sugiere una tasa cercana o superior a los 14 casos por cada 100.000 habitantes, seguida por el resto de Galicia y Asturias, así como ciertas zonas de Andalucía oriental y el interior norte (como Zamora). En contraposición, se observa una notable "zona valle" en el centro del país, donde provincias como Madrid y Guadalajara presentan los tonos más claros de la escala, indicando las tasas medias más bajas del periodo (situadas en el rango de 4 a 6), lo que evidencia una fuerte disparidad regional entre la periferia noroeste y el centro de la península.

### Suicidio por edad (JSON)
```{r , eval = TRUE,message=FALSE}
# Gráfico 4.4.3: Suicidio por edad (CORREGIDO)
# La corrección está en aes(fill = sexo) -> (todo en minúscula)

ggplot(Suicidios_Edad, aes(x = edad, y = Valor, fill = sexo)) + 
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


### Union CSV + JSON 
Como el CSV tiene los datos en referencia a 100.000 habitantes, vamos a hacer lo mismo con el JSON y así podremos compararlos.

**1. Creacción de la tabla de referencia**
En este paso,creamos una tabla de referencia de población, para ello usamos los datos oficiales totales de hombres y mujeres encontrados en INE.
En esta nueva tabla la columna sexo será clave para unirla posteriormente con nuestros datos.

```{r , eval = TRUE,message=FALSE}

poblacion_ref <- data.frame(
  sexo = c("Hombres", "Mujeres"),
  Poblacion_Nacional = c(23265381, 24210039) 
)

print(poblacion_ref)

```
**2. Unión y cálculo de tasas**

Unimos la nueva tabla creada con la población de referencia al JSON y calculamos las tasas.
Left_join: Esta función incorpora los datos de la tabla calculada anteriormente (poblacion_ref) a nuestra tabla principal (suicidios_edad). Busca coindidencias en la columna comun 'sexo' y añade la columna 'Poblacion_Nacional' a cada fila correspondiente.
mutate(Tasa_aportacion...): crea una nueva columna calculada que nos da la tasa específica de ese grupo de edad. Nos dice cuantos suicidios aporta ese rango de edad para cada 100.000 habitantes de ese sexo. 

```{r , eval = TRUE,message=FALSE}
# Partimos de la tabla 'Suicidios_Edad' que creamos al procesar el JSON
Suicidios_Con_Tasas <- Suicidios_Edad %>%
  # Unimos con nuestra tabla de población manual mediante un left_join
  left_join(poblacion_ref, by = "sexo") %>%
  # Calculamos la tasa por 100.000 habitantes
  mutate(Tasa_Aportacion = (Valor / Poblacion_Nacional) * 100000)

# Visualizamos la tabla resultante
head(Suicidios_Con_Tasas)

```

**3. Gráfico comparativo**

Generamos un gráfico de barras para visualizar las tasas calculadas para cada grupo de edad, confirmando que se corresponde con la misma forma del anterior gráfico, pero esta vez, calculado con la tasa por cada 100.000 habitantes del mismo sexo.

```{r , eval = TRUE,message=FALSE}
#En el eje X ponemos los grupos de edad y en el eje Y la tasa calculada.
#Con 'dodge', las barras de hombres y mujeres se colocan una al lado de otra, evitando solapamientos. 
ggplot(Suicidios_Con_Tasas, aes(x = edad, y = Tasa_Aportacion, fill = sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Hombres" = "#1f77b4", "Mujeres" = "#ff7f0e")) +
  labs(
    title = "Tasa de suicidios por grupo de edad (2022)",
    subtitle = "Tasa por cada 100.000 habitantes del mismo sexo",
    y = "Tasa (x 100.000 hab.)",
    x = "Grupo de Edad"
  ) +
  theme_minimal() +
  #rotamos 45 grados las etiquetas del eje X porque los nombres de los grupos de edad son largos y si no se solaparían.
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "top"
  )
```


**4. Validación (unión)**

Este es el paso de control de calidad para demostrar que las fuentes (CSV y JSON) son coherentes entre sí.
- validacion_json: Agrupamos los datos del JSON por sexo y sumamos todas las tasas parciales de los grupos de edad. La suma de las partes debe dar el total nacional.
- validacion_csv: Filtramos para quedarnos solo con el dato nacional de 2022 (ya que el JSON  se corresponde también con dicho año)
- left_join: Une los dos resultados en una sola tabla (comparativa_fuentes). Si los números coindicen, hemos demostrado que la integración de los datos es correcta. 

```{r , eval = TRUE,message=FALSE}
# 1. Calculamos la tasa total del JSON
validacion_json <- Suicidios_Con_Tasas %>%
  group_by(sexo) %>%
  summarise(Tasa_Calculada_JSON = sum(Tasa_Aportacion))

# 2. Sacamos la tasa del CSV (¡Ahora ya está limpia!)
validacion_csv <- provincias %>% 
  filter(Provincias == "Nacional", Periodo == 2022, Sexo != "Total") %>%
  select(Sexo, Tasa_Oficial_CSV = Total)

# 3. Unimos ambas tablas
comparativa_fuentes <- left_join(validacion_json, validacion_csv, by = c("sexo" = "Sexo"))

print(comparativa_fuentes)


# 4. Para poner la tabla bonita 
#library(knitr)
#kable(comparativa_fuentes, 
     # col.names = c("Sexo", "Tasa JSON (Calculada)", "Tasa CSV (Oficial)"),
     # digits = 2, 
     # caption = "Validación de tasas (2022)")

```

**5- Gráfico comparando CSV y JSON**

Representamos gráficamente la validación anterior. El siguiente gráfico nos permite confirmar visualmente la cosistencia entre nuestras dos fuentes de datos. Si las barras de cada par tienen la misma altura, significa que la integración de los datos absolutos del JSON con las tasas oficiales del CSV se corresponden.
```{r , eval = TRUE,message=FALSE}
# 1. Preparamos los datos 

# A) Datos del JSON (Calculados)
datos_json <- comparativa_fuentes %>%
  select(sexo, Tasa = Tasa_Calculada_JSON) %>%
  mutate(
    Fuente = "Cálculo propio (JSON)",
    Tasa = as.numeric(Tasa) # Aseguramos que sea número
  )

# B) Datos del CSV (Oficiales) 
datos_csv <- comparativa_fuentes %>%
  select(sexo, Tasa = Tasa_Oficial_CSV) %>%
  mutate(
    Fuente = "Dato Oficial (CSV)",
    # Pasamos a texto -> cambiamos coma por punto -> pasamos a número
    Tasa = as.numeric(gsub(",", ".", as.character(Tasa)))
  )

# C) Unimos las dos tablas (ahora sí, ambas son numéricas)
datos_grafico <- bind_rows(datos_json, datos_csv)

# 2. Creamos el gráfico de barras agrupadas
ggplot(datos_grafico, aes(x = sexo, y = Tasa, fill = Fuente)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = round(Tasa, 2)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, size = 3.5) +
  scale_fill_manual(values = c("Cálculo propio (JSON)" = "#2ca02c", "Dato Oficial (CSV)" = "#7f7f7f")) +
  labs(
    title = "Comparativa de consistencia entre fuentes de datos",
    subtitle = "Tasa de suicidio por sexo (Año 2022)",
    y = "Tasa (por 100.000 hab.)",
    x = "Sexo",
    fill = "Fuente de datos"
  ) +
  theme_minimal() +
  theme(legend.position = "top")
``` 

INTERPRETACIÓN Y VALIZACIÓN DE RESULTADOS

El gráfico de barras agrupadas compara las tasas de suicidio por sexo obtenidas de dos formas distintas:
- Dato oficial (CSV): La tasa publicada directamente por el INE
- Cálculo propio (JSON): La tasa que hemos calculado nosotros mismos sumando los suicidios absolutos por edad del JSON y dividiéndolos por la población oficial de España.

Como se puede observar, las barras verdes y las grises son prácticamente idénticas tanto para hombres como para mujeres. Esta coincidencia nos permite afirmar:
- La validación metodológica, nuestro procedimiento para unir las bases de datos y calcular las tasas por edad ha sido correcto. 
- La consistencia de los datos, confirmarmos que ambas fuentes de datos del INE son coherentes entre sí, asegurando que los análisis detallados que hemos realizado anteriormente son representativos y fiables.


**6. Análisis brecha de género**

Para finalizar, calculamos cuántos hombres se suicidan por cada mujer en cada grupo de edad. Este gráfico responde a la pregunta: "¿Por cada mujer que se suicida en este grupo de edad, cuántos hombres lo hacen?. Un valor de 1 significa igualdad, un valor de 3 significa que hay 3 veces más suicidios masculinos en dicho grupo.

```{r , eval = TRUE,message=FALSE}
# 1. Preparamos los datos: Pivotamos para tener Hombres y Mujeres en columnas
brecha_genero <- Suicidios_Con_Tasas %>%
  select(edad, sexo, Tasa_Aportacion) %>%
  pivot_wider(names_from = sexo, values_from = Tasa_Aportacion) %>%
  # Calculamos el Ratio (Cuántos hombres por cada mujer)
  mutate(Ratio_H_M = Hombres / Mujeres)

# 2. Gráfico de Piruleta (Lollipop Chart) para visualizar la diferencia
ggplot(brecha_genero, aes(x = edad, y = Ratio_H_M)) +
  # Línea vertical desde 0 hasta el punto
  geom_segment(aes(x = edad, xend = edad, y = 0, yend = Ratio_H_M), color = "grey") +
  # Punto en el valor del ratio
  geom_point(size = 4, color = "#1f77b4") +
  # Texto con el valor exacto
  geom_text(aes(label = round(Ratio_H_M, 1)), vjust = -0.8, size = 3) +
  labs(
    title = "Brecha de género en el suicidio por edad",
    subtitle = "Ratio de masculinidad: Número de suicidios masculinos por cada suicidio femenino",
    y = "Ratio (Hombres / Mujeres)",
    x = "Grupo de Edad"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
INTERPRETACIÓN

Este análisis revela que el suicidio es un fenómeno muy masculinizado en todos los grupos de edad (todos los ratios son superiores a 1). Sin embargo, observamos que la brecha no es constante, se dispara en el grupo de 85 a 89 años, donde hay casi 5 hombres por cada mujer.



# CONCLUSIONES
Tras el análisis comparativo de las tasas de suicidio en España utilizando datos oficiales del INE, podemos extraer las siguientes conclsiones princiaples:
- una linea por grafico
.............



Este análisis de datos destaca la necesidad de estrategías de prevención dirigidas específicamente a los grupos de mayor riesgo identificados: hombres y....

# REFERENCIAS 







