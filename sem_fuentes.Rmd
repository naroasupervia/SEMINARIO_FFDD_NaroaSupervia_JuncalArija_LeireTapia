---
title: "Datos suicidio"
author: "Juncal Arija, Naroa Supervia, Leire Tapia"
date: "2025-11-06"
output:
  html_document:
    theme: cerulean       # Otras opciones: united, cosmo, journal, readable
    highlight: tango      # Colores de sintaxis: pygments, tango, zenburn...
    toc: true             # A√±ade tabla de contenidos
    toc_float: true       # TOC flotante que se desplaza al hacer scroll
    number_sections: true # Numera cap√≠tulos y secciones
    fig_width: 7
    fig_height: 5
    df_print: paged       # Tablas interactivas tipo DT
  pdf_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **INTRODUCCI√ìN**
contextualiza la idea del seminario, entrega una idea general de la tem√°tica, de lo que se sabe y sobre todo de lo que no se sabe y quer√©is abordar en vuestro trabajo.

El suicidio es un fen√≥meno ocmplejo que constituye un importante problema de salud p√∫blica en Espa√±a y en el mundo. Aunque se dispone de informaci√≥n general sobre la mortalidad por suicidio, la evidencia cient√≠fica revela diferencias significativas seg√∫n el sexo, la edad y el territorio.

En este seminario, nos proponemos comparar el suicidio utilizando distintos conjuntos de datos (sexo, edad y territorio) para explorar las diferencias y analizar a que se deben.



# **OBJETIVOS** 
1. Describir la distribuci√≥n del suicidio por sexo en Espa√±a. 

2. Analizar las diferencias entre provincias. 

3. Estudiar la influencia del grupo de edad en la cantidad de suicidios. 

4. Unificar los datos CSV y JSON para obtener una vista m√°s completa. 

5. (Opcional) Explorar si existe relaci√≥n entre grupos de edad + provincias + sexo. 



# **PAQUETES UTILIZADOS**
Para poder utilizar nuestros conjuntos de datos es necesario importar las siguientes librerias y paquetes:

```{r , eval = TRUE,message=FALSE, warning=FALSE}
# Datos con formato .csv:
library(readr)

#Datos con formato .json:
library(tidyverse)
library(rjson)
library(jsonlite)
library(tidyjson)

#Visualizacion resultados:
library(DT)
library(ggplot2)
library(gifski)
library(gganimate)
library(plotly)
library(dplyr)
library(mapSpain)
library(knitr) # librer√≠a para tablas 
```



# **DESARROLLO Y RESULTADOS**
Una vez cargadas las librerias importamos los datos

## OBTENCI√ìN DE LOS DATOS 
Para este trabajo se han utilizado dos conjuntos de datos procedentes del Instituto Nacional de Estad√≠sitca (INE), a trav√©s de sus estad√≠sticas oficiales sobre defunciones seg√∫n causa de muerte. Ambas fuentes se han descargado directamente desde la herramienta de consulta del INE y contienen informaci√≥n actualizada y validada por el organismo. 

- **provincias_sexo.csv**: Este archivo recoge la tasa de suicidios por cada 100.000 habitantes en Esapa√±a, desglosada por: provincia, sexo (total, hombes, mujeres) y a√±o (2021, 2022 y 2023). 
Cada fila representa la tasa correspondiente a un territorio y un sexo concreto en un a√±o determinado.
Estos valores provienen directamente el INE y reflejan las tasas oficiales calculadas del instituto, basadas en la poblaci√≥n residente de cada a√±o. 
Este archivo le hemos utilizado para:
  - Analizar la evoluci√≥n reciente (2021 - 2023) 
  - Las diferencias entre sexos 
  - Las variaciones territoriales entre provincias.

- **suicidio_Edad-Sexo.json**: Este JSON  contiene el n√∫mero absoluto de suicidios registrados a nivel nacional en el a√±o 2022 (creemos). Est√° desglosado por grupo de edad y por sexo. 
La estructura del Json incluye:
  - Un campo MetaData, donde se especif√≠ca el sexo y el grupo de edad.
  - Un campo Data, donde aparece el valor num√©rico de suicidios en ese grupo.
Estos datos tambi√©n han sido descargados del INE y corresponden al mismo sistema estad√≠stico, pero en este caso sin convertirlos en tasas, es decir, son num√©ros absolutos de casos, no tasas de poblaci√≥n.
Este archivo se ha empleado para:
  - Calcular los suicidios totales por sexo
  - Relacionar los valores con la poblaci√≥n para obtener tasas a medida
  - Analizar diferencias entre grupos de edad
  
En resumen, el CSV ofrece tasas por provincia, sexo y a√±o, mientras que el JSON proporciona n√∫meros absolutos por edad y sexo a nivel nacional. Esta combinaci√≥n permite un an√°lisis estad√≠stico completo tanto a nivel territorial como demogr√°fico. 


## IMPORTACI√ìN DE LOS DATOS

### **IMPORTACI√ìN DATOS CSV**
En algunos de nuestros archivos csv, es necesario especificar el tipo de codificaci√≥n que tienen, para que R pueda leer correctamente los caracteres especiales como *tildes* o *√±*. En nuestro caso utilizan la codificacion *ISO 8859-1* que corresponde con el alfabeto espa√±ol??? :

```{r , eval = TRUE,message=FALSE}

# Para conocer el tipo de codificaci√≥n: 
encoding <- guess_encoding("INPUT/DATA/provincias_sexo.csv")
print(encoding)

```

```{r , eval = TRUE,message=FALSE}

provincias <- read_delim("INPUT/DATA/provincias_sexo.csv", 
                         delim = ";", trim_ws = TRUE, 
                         locale = locale(encoding = "ISO-8859-1"),
                         # FORZAMOS QUE TODO SE LEA COMO TEXTO AL PRINCIPIO
                         col_types = cols(.default = "c"))
head(provincias)
```
### IMPORTACI√ìN DEL JSON


```{r , eval = TRUE,message=FALSE}

# Ruta al archivo JSON
ruta_json <- "INPUT/DATA/Suicidio_Edad-Sexo.json"

# Importar JSON y convertir a dataframe
suicidios_json <- fromJSON(ruta_json)
#suicidios_json <- as.data.frame(suicidios_json)

# Mostrar las primeras filas
head(suicidios_json)

```


## FILTRADO Y PREPARACI√ìN DE LOS DATOS
Los datos han sido filtrados y preparados para asegurar la coherencia entre las fuentes. Se eliminaron los totales generales en sexo para poder comparar hombres y mujeres. Se normaliz√≥ el nombre de las provincias para ....noseq
y se separ√≥ el json en edad, sexo y valor para noseqqq

### Convertir la columna 'Total' del CSV de texto a n√∫mero
```{r , eval = TRUE,message=FALSE}
provincias <- provincias %>%
  mutate(
    # Ahora 'Total' es texto seguro (ej: "13,34").
    # Cambiamos la coma por punto.
    Total = as.numeric(gsub(",", ".", Total)),
    # Aprovechamos para convertir 'Periodo' a n√∫mero tambi√©n
    Periodo = as.numeric(Periodo)
  )

# Ahora creamos el dataframe filtrado
Suicidios_CSV_filtrado <- provincias %>%
  filter(Sexo != "Total", 
         Provincias != "Nacional")

# Verificamos: Total debe ser <dbl> (n√∫mero real con decimales)
head(Suicidios_CSV_filtrado)
```


### Normalizar nombres de provincias (quitar tildes, √± o cosas q hagan q los nombres se vean mal)
```{r , eval = TRUE,message=FALSE}
# Crear el dataframe filtrado para el gr√°fico
# (Usa el dataframe 'provincias' que ya cargaste y mutaste)
Suicidios_CSV_filtrado <- provincias %>%
  filter(Sexo != "Total", 
         Provincias != "Nacional")

# Ver el resultado (opcional)
head(Suicidios_CSV_filtrado)
```

### Eliminar "total" en sexo
Para as√≠ comparar hombres vs mujeres 
(entonces yo quitar√≠a lo de cambiar el separador decimal xq si quitamos el total no nos hace falta camibar lo de . por , nose)

```{r , eval = TRUE,message=FALSE}
library(dplyr)
library(purrr)
library(tidyr)

# ===============================
# 1. Provincias: eliminar "Total" en Sexo
# ===============================
provincias_filtrado <- provincias %>%
  filter(Sexo != "Total")

# Revisar resultado
head(provincias_filtrado)
```


### El JSON:separar edad y sexo
Extraer:
- Lista de edades
- Lista de sexos
- Valor 
```{r , eval = TRUE,message=FALSE}
# Chunk CORREGIDO para: ### El JSON:separar edad y sexo
# (Aseg√∫rate de tener 'library(tidyverse)' y 'library(jsonlite)' en tu chunk de paquetes)

# Este c√≥digo usa un m√©todo m√°s robusto para "aplanar" el JSON
# y evitar que se creen valores NA.

Suicidios_Edad <- as_tibble(suicidios_json) %>%
  
  # 1. Extraer el 'Valor' de la sub-lista 'Data'
  #    (map_dbl toma cada elemento de 'Data' y extrae el primer 'Valor')
  mutate(Valor = map_dbl(Data, ~ .x$Valor[1])) %>%
  
  # 2. Guardar el 'Nombre' original (ej. "De 15 a 29 a√±os, Hombres")
  #    como un ID √∫nico para agrupar las filas.
  select(ID_Fila = Nombre, Valor, MetaData) %>%
  
  # 3. Desanidar 'MetaData', que crear√° dos filas por cada ID_Fila
  #    (una para 'edad' y otra para 'sexo')
  unnest(MetaData) %>%
  
  # 4. Seleccionar solo las columnas que necesitamos para pivotar
  select(ID_Fila, Valor, T3_Variable, Nombre) %>%

  # 5. Pivotar usando el ID_Fila. Esto asegura que la 'edad' y el 'sexo'
  #    del mismo ID_Fila terminen en la misma fila, junto a su 'Valor'.
  pivot_wider(names_from = T3_Variable, values_from = Nombre) %>%
  
  # 6. Filtrar los totales (como antes)
  filter(sexo != "Ambos sexos",
         edad != "Todas las edades") %>%
  
  # 7. (Opcional) Quitar la columna de ID, ya no la necesitamos
  select(edad, sexo, Valor)

# Ver el resultado (opcional)
# Esta tabla ya no deber√≠a tener NAs en 'edad' o 'sexo'
print("Datos JSON (versi√≥n final) listos:")
head(Suicidios_Edad)
```

## RESULTADOS 
Aqu√≠ vienen los gr√°ficos

### Suicidio por sexo a nivel nacional
Usando los datos del JSON, a partir de la tabla Suicidios_Edad (con las columnas sexo, edad y valor), agrupamos los datos que tengan el mismo valor en la columna sexo (hombres/mujeres) y para cada grupo hemos calculado la suma total de la columna valor. Como resultado obtenemos un nuevo tibble de 2 filas (una por sexo), con las columnas sexo y total.
Con el nuevo tibble creamos un gr√°fico de barras.
```{r , eval = TRUE,message=FALSE}
# Sumar los valores por sexo
suicidio_sexo_nacional <- Suicidios_Edad %>%
  group_by(sexo) %>%
  summarise(Total = sum(Valor, na.rm = TRUE))

# Revisar tabla
print(suicidio_sexo_nacional)

# #GRAFICO DE BARRAS (suicidios por sexo a nivel nacional)
ggplot(suicidio_sexo_nacional, aes(x = sexo, y = Total, fill = sexo)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Suicidios por sexo a nivel nacional",
    x = "Sexo",
    y = "N√∫mero total de suicidios"
  ) +
  scale_fill_manual(values = c("Hombres" = "#1f77b4", "Mujeres" = "#ff7f0e")) +
  theme_minimal()
```

Podemos representar los datos anteriores en otros tipos de gr√°fico, por ejemplo el gr√°fico circular.
Igual que en el anterior, agrupamos los datos que tengan el mismo valor en la columna sexo, y para cada grupo calculamos la suma total de la columna valor, obteniendo como resultado un nuevo tibble para llevar a cabo el gr√°fico circular.
```{r , eval = TRUE,message=FALSE}
# 1. Filtrar datos a nivel nacional (ya que JSON tiene solo sexo y edad, sumamos por sexo)
nacional_sexo <- Suicidios_Edad %>%
  group_by(sexo) %>%
  summarise(Total = sum(Valor))

print(nacional_sexo) #visualizamos el nuevo tibble

#GR√ÅFICO CIRCULAR
ggplot(nacional_sexo, aes(x = "", y = Total, fill = sexo)) +
  geom_bar(stat = "identity", width = 1) +   # barra para convertir a circular
  coord_polar(theta = "y") +                 # transforma a circular
  labs(title = "Suicidios por sexo a nivel nacional") +
  theme_minimal() +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  scale_fill_manual(values = c("Hombres" = "steelblue", "Mujeres" = "pink"))
```  

INTERPRETACI√ìN
El gr√°fico de barras compara el total de suicidios entre hombres y mujeres, muestra que los hombreses presentan un mayor n√∫mero de suicidios. El gr√°fico circular representa la misma informaci√≥n, pero en proporciones del total, muestra que los hombres representan aproximadamente el 75% de los suicidios a nivel nacional, mientras que las mujeres el 25%. 

En conclusi√≥n, los an√°lisis del total de suicidios seg√∫n el sexo muestra una diferencia clara entre hombres y mujeres.
En Espa√±a, el n√∫mero total de suicidios es significativamente mayor en hombres que en mujeres, lo cual coincide con las estad√≠sitcas nacionales e internacionales, donde los hombres presentan tasas de suicidio m√°s elevadas a pesar de que las mujeres registran m√°s intentos no letales.
Este patr√≥n puede estar asociado a factores socioculturales, diferencias en m√©todos utilizados, menor b√∫squeda de ayuda por parte de los hombres o barreras sociales relaccionadas con la salud mental.


```{r , eval = TRUE,message=FALSE}
#Tabla interactiva, buscar por a√±o...
datatable(provincias,
          caption = 'Tabla 1: Tasas de suicidio por provincia y sexo',
          options = list(pageLength = 10, autoWidth = TRUE, scrollX = TRUE))
```



### Suicidio por provincia
```{r , eval = TRUE,message=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(plotly)
library(scales) 
library(stringr) 

# Esta opci√≥n mejora la visualizaci√≥n de n√∫meros largos
options(scipen = 999) 

# 1. LIMPIEZA Y FILTRADO (Partimos de la variable 'provincias' ya cargada)
Suicidios_CSV_filtrado_FINAL <- provincias %>%
  # 1. Filtrar Nacional y Total (como ya lo haces)
  filter(Sexo != "Total",
         Provincias != "Nacional") %>%
  mutate(
    # 2. Eliminar c√≥digo num√©rico y espacio inicial (ej: "01 " de "01 Araba/√Ålava")
    Nombre_Limpio = str_remove(Provincias, "^\\d{1,2}\\s"),
    
    # 3. Arreglos para nombres biling√ºes/largos y unificar entradas
    Nombre_Final = case_when(
        str_detect(Nombre_Limpio, "Alacant/Alicante") ~ "Alicante",
        str_detect(Nombre_Limpio, "Castell√≥/Castell√≥n") ~ "Castell√≥n",
        str_detect(Nombre_Limpio, "Val√®ncia/Valencia") ~ "Valencia",
        str_detect(Nombre_Limpio, "Araba/√Ålava") ~ "√Ålava", 
        str_detect(Nombre_Limpio, "Balears, Illes") ~ "Baleares",
        str_detect(Nombre_Limpio, "A Coru√±a") ~ "A Coru√±a",
        # üí• Arreglo para que las may√∫sculas (√ÅVILA, LE√ìN) pasen a min√∫scula y t√≠tulo
        TRUE ~ str_to_title(tolower(Nombre_Limpio))
    )
  )


# 2. CREA el gr√°fico de ggplot
p <- ggplot(Suicidios_CSV_filtrado_FINAL, aes(x = Sexo, y = Total, color = Sexo)) + 
  geom_point(size = 3, alpha = 0.8) + 
  # Usamos la columna Nombre_Final limpia para el facetado
  facet_wrap(~Nombre_Final, ncol = 6) + 
  labs(
    title = "Tasa de Suicidio por Provincia y Sexo (2021-2023)",
    subtitle = "Tasa por 100.000 habitantes. Se excluye el dato nacional.",
    x = "Sexo",
    y = "Tasa Total (x 100.000 hab.)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0), 
    strip.text = element_text(size = 7),
    legend.position = "bottom"
  ) +
  # üí• FUERZA DE FORMATO 1: Coma decimal y punto para miles
  scale_y_continuous(labels = label_number(big.mark = ".", decimal.mark = ","))

# 3. CONVI√âRTELO en interactivo
p_plotly <- ggplotly(p)

# 4. FUERZA DE FORMATO 2 (Refuerzo en Plotly)
p_plotly <- p_plotly %>%
  layout(yaxis = list(tickformat = ",.1f", 
                      hoverformat = ",.3f" 
                      ))

p_plotly
```
###Mapa interactivo

### MAPA INTERACTIVO DE SUICIDIO POR PROVINCIA
```{r , eval = TRUE, message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(plotly)
library(mapSpain)
library(stringr)
library(scales)

# 1. LECTURA Y LIMPIEZA INICIAL DE DATOS
provincias_raw <- read_delim("INPUT/DATA/provincias_sexo.csv",
                         delim = ";", trim_ws = TRUE,
                         locale = locale(encoding = "ISO-8859-1"),
                         show_col_types = FALSE)

provincias_raw$Total <- as.numeric(gsub(",", ".", provincias_raw$Total))
provincias_raw$Periodo <- as.numeric(provincias_raw$Periodo)


# 2. AGREGACI√ìN Y PREPARACI√ìN DE C√ìDIGOS
datos_mapa <- provincias_raw %>%
  filter(Sexo != "Total", Provincias != "Nacional") %>%
  mutate(
    # Extraemos los dos primeros d√≠gitos del nombre de la provincia (c√≥digo INE)
    cod_join = str_sub(Provincias, 1, 2)
  ) %>%
  
  # Agrupamos por el C√ìDIGO
  group_by(cod_join) %>%
  summarise(
    Tasa_Media = mean(Total, na.rm = TRUE),
    # üí• CORRECCI√ìN CR√çTICA: Mantenemos el nombre original de la provincia üí•
    Nombre_Provincia_Original = first(Provincias), 
    .groups = 'drop'
  )


# 3. DESCARGAR GEOMETR√çA DEL MAPA Y UNIR DATOS POR C√ìDIGO
mapa_provincias <- esp_get_prov_siane(resolution = 10)

# UNI√ìN POR C√ìDIGO INE (campo 'cpro' en el objeto de mapSpain)
mapa_datos <- mapa_provincias %>%
  mutate(cpro_join = as.character(cpro)) %>%
  left_join(datos_mapa, by = c("cpro_join" = "cod_join"))


# 4. CREAR EL GR√ÅFICO CHOROPLETH (Interactivo)
p_mapa <- ggplot(mapa_datos) +
  geom_sf(aes(fill = Tasa_Media, 
              # üí• USO DE LA COLUMNA GARANTIZADA: Nombre_Provincia_Original üí•
              text = paste("Provincia:", str_remove(Nombre_Provincia_Original, "^\\d{1,2}\\s"), 
                           "<br>Tasa Media (x 100k):", format(Tasa_Media, big.mark = ".", decimal.mark = ","))
              )) +
  # Escala de colores (m√°s fuerte = m√°s muertes)
  scale_fill_gradient(
    low = "#fef0d9",  
    high = "#b30000", 
    name = "Tasa Media (x 100k hab.)",
    labels = label_number(big.mark = ".", decimal.mark = ",") 
  ) +
  labs(
    title = "Tasa Media de Suicidio por Provincia (2021-2023)",
    caption = "Fuente: INE."
  ) +
  theme_void() + 
  theme(legend.position = "bottom")

# Convertir a Plotly para la interactividad (tooltip y zoom)
ggplotly(p_mapa, tooltip = "text")
```
### Suicidio por edad (JSON)
```{r , eval = TRUE,message=FALSE}
# Gr√°fico 4.4.3: Suicidio por edad (CORREGIDO)
# La correcci√≥n est√° en aes(fill = sexo) -> (todo en min√∫scula)

ggplot(Suicidios_Edad, aes(x = edad, y = Valor, fill = sexo)) + 
  geom_bar(stat = "identity", position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


### Union CSV + JSON 
Como el CSV tiene los datos en referencia a 100.000 habitantes, vamos a hacer lo mismo con el JSON y as√≠ podremos compararlos.

**1. Creacci√≥n de la tabla de referencia**
En este paso,creamos una tabla de referencia de poblaci√≥n, para ello usamos los datos oficiales totales de hombres y mujeres encontrados en INE.
En esta nueva tabla la columna sexo ser√° clave para unirla posteriormente con nuestros datos.

```{r , eval = TRUE,message=FALSE}

poblacion_ref <- data.frame(
  sexo = c("Hombres", "Mujeres"),
  Poblacion_Nacional = c(23265381, 24210039) 
)

print(poblacion_ref)

```
**2. Uni√≥n y c√°lculo de tasas**

Unimos la nueva tabla creada con la poblaci√≥n de referencia al JSON y calculamos las tasas.
Left_join: Esta funci√≥n incorpora los datos de la tabla calculada anteriormente (poblacion_ref) a nuestra tabla principal (suicidios_edad). Busca coindidencias en la columna comun 'sexo' y a√±ade la columna 'Poblacion_Nacional' a cada fila correspondiente.
mutate(Tasa_aportacion...): crea una nueva columna calculada que nos da la tasa espec√≠fica de ese grupo de edad. Nos dice cuantos suicidios aporta ese rango de edad para cada 100.000 habitantes de ese sexo. 

```{r , eval = TRUE,message=FALSE}
# Partimos de la tabla 'Suicidios_Edad' que creamos al procesar el JSON
Suicidios_Con_Tasas <- Suicidios_Edad %>%
  # Unimos con nuestra tabla de poblaci√≥n manual mediante un left_join
  left_join(poblacion_ref, by = "sexo") %>%
  # Calculamos la tasa por 100.000 habitantes
  mutate(Tasa_Aportacion = (Valor / Poblacion_Nacional) * 100000)

# Visualizamos la tabla resultante
head(Suicidios_Con_Tasas)

```

**3. Gr√°fico comparativo**

Generamos un gr√°fico de barras para visualizar las tasas calculadas para cada grupo de edad, confirmando que se corresponde con la misma forma del anterior gr√°fico, pero esta vez, calculado con la tasa por cada 100.000 habitantes del mismo sexo.

```{r , eval = TRUE,message=FALSE}
#En el eje X ponemos los grupos de edad y en el eje Y la tasa calculada.
#Con 'dodge', las barras de hombres y mujeres se colocan una al lado de otra, evitando solapamientos. 
ggplot(Suicidios_Con_Tasas, aes(x = edad, y = Tasa_Aportacion, fill = sexo)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("Hombres" = "#1f77b4", "Mujeres" = "#ff7f0e")) +
  labs(
    title = "Tasa de suicidios por grupo de edad (2022)",
    subtitle = "Tasa por cada 100.000 habitantes del mismo sexo",
    y = "Tasa (x 100.000 hab.)",
    x = "Grupo de Edad"
  ) +
  theme_minimal() +
  #rotamos 45 grados las etiquetas del eje X porque los nombres de los grupos de edad son largos y si no se solapar√≠an.
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "top"
  )
```


**4. Validaci√≥n (uni√≥n)**

Este es el paso de control de calidad para demostrar que las fuentes (CSV y JSON) son coherentes entre s√≠.
- validacion_json: Agrupamos los datos del JSON por sexo y sumamos todas las tasas parciales de los grupos de edad. La suma de las partes debe dar el total nacional.
- validacion_csv: Filtramos para quedarnos solo con el dato nacional de 2022 (ya que el JSON  se corresponde tambi√©n con dicho a√±o)
- left_join: Une los dos resultados en una sola tabla (comparativa_fuentes). Si los n√∫meros coindicen, hemos demostrado que la integraci√≥n de los datos es correcta. 

```{r , eval = TRUE,message=FALSE}
# 1. Calculamos la tasa total del JSON
validacion_json <- Suicidios_Con_Tasas %>%
  group_by(sexo) %>%
  summarise(Tasa_Calculada_JSON = sum(Tasa_Aportacion))

# 2. Sacamos la tasa del CSV (¬°Ahora ya est√° limpia!)
validacion_csv <- provincias %>% 
  filter(Provincias == "Nacional", Periodo == 2022, Sexo != "Total") %>%
  select(Sexo, Tasa_Oficial_CSV = Total)

# 3. Unimos ambas tablas
comparativa_fuentes <- left_join(validacion_json, validacion_csv, by = c("sexo" = "Sexo"))

print(comparativa_fuentes)


# 4. Para poner la tabla bonita 
#library(knitr)
#kable(comparativa_fuentes, 
     # col.names = c("Sexo", "Tasa JSON (Calculada)", "Tasa CSV (Oficial)"),
     # digits = 2, 
     # caption = "Validaci√≥n de tasas (2022)")

```

**5- Gr√°fico comparando CSV y JSON**

Representamos gr√°ficamente la validaci√≥n anterior. El siguiente gr√°fico nos permite confirmar visualmente la cosistencia entre nuestras dos fuentes de datos. Si las barras de cada par tienen la misma altura, significa que la integraci√≥n de los datos absolutos del JSON con las tasas oficiales del CSV se corresponden.
```{r , eval = TRUE,message=FALSE}
# 1. Preparamos los datos 

# A) Datos del JSON (Calculados)
datos_json <- comparativa_fuentes %>%
  select(sexo, Tasa = Tasa_Calculada_JSON) %>%
  mutate(
    Fuente = "C√°lculo propio (JSON)",
    Tasa = as.numeric(Tasa) # Aseguramos que sea n√∫mero
  )

# B) Datos del CSV (Oficiales) 
datos_csv <- comparativa_fuentes %>%
  select(sexo, Tasa = Tasa_Oficial_CSV) %>%
  mutate(
    Fuente = "Dato Oficial (CSV)",
    # Pasamos a texto -> cambiamos coma por punto -> pasamos a n√∫mero
    Tasa = as.numeric(gsub(",", ".", as.character(Tasa)))
  )

# C) Unimos las dos tablas (ahora s√≠, ambas son num√©ricas)
datos_grafico <- bind_rows(datos_json, datos_csv)

# 2. Creamos el gr√°fico de barras agrupadas
ggplot(datos_grafico, aes(x = sexo, y = Tasa, fill = Fuente)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  geom_text(aes(label = round(Tasa, 2)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, size = 3.5) +
  scale_fill_manual(values = c("C√°lculo propio (JSON)" = "#2ca02c", "Dato Oficial (CSV)" = "#7f7f7f")) +
  labs(
    title = "Comparativa de consistencia entre fuentes de datos",
    subtitle = "Tasa de suicidio por sexo (A√±o 2022)",
    y = "Tasa (por 100.000 hab.)",
    x = "Sexo",
    fill = "Fuente de datos"
  ) +
  theme_minimal() +
  theme(legend.position = "top")
``` 

INTERPRETACI√ìN Y VALIZACI√ìN DE RESULTADOS

El gr√°fico de barras agrupadas compara las tasas de suicidio por sexo obtenidas de dos formas distintas:
- Dato oficial (CSV): La tasa publicada directamente por el INE
- C√°lculo propio (JSON): La tasa que hemos calculado nosotros mismos sumando los suicidios absolutos por edad del JSON y dividi√©ndolos por la poblaci√≥n oficial de Espa√±a.

Como se puede observar, las barras verdes y las grises son pr√°cticamente id√©nticas tanto para hombres como para mujeres. Esta coincidencia nos permite afirmar:
- La validaci√≥n metodol√≥gica, nuestro procedimiento para unir las bases de datos y calcular las tasas por edad ha sido correcto. 
- La consistencia de los datos, confirmarmos que ambas fuentes de datos del INE son coherentes entre s√≠, asegurando que los an√°lisis detallados que hemos realizado anteriormente son representativos y fiables.


**6. An√°lisis brecha de g√©nero**

Para finalizar, calculamos cu√°ntos hombres se suicidan por cada mujer en cada grupo de edad. Este gr√°fico responde a la pregunta: "¬øPor cada mujer que se suicida en este grupo de edad, cu√°ntos hombres lo hacen?. Un valor de 1 significa igualdad, un valor de 3 significa que hay 3 veces m√°s suicidios masculinos en dicho grupo.

```{r , eval = TRUE,message=FALSE}
# 1. Preparamos los datos: Pivotamos para tener Hombres y Mujeres en columnas
brecha_genero <- Suicidios_Con_Tasas %>%
  select(edad, sexo, Tasa_Aportacion) %>%
  pivot_wider(names_from = sexo, values_from = Tasa_Aportacion) %>%
  # Calculamos el Ratio (Cu√°ntos hombres por cada mujer)
  mutate(Ratio_H_M = Hombres / Mujeres)

# 2. Gr√°fico de Piruleta (Lollipop Chart) para visualizar la diferencia
ggplot(brecha_genero, aes(x = edad, y = Ratio_H_M)) +
  # L√≠nea vertical desde 0 hasta el punto
  geom_segment(aes(x = edad, xend = edad, y = 0, yend = Ratio_H_M), color = "grey") +
  # Punto en el valor del ratio
  geom_point(size = 4, color = "#1f77b4") +
  # Texto con el valor exacto
  geom_text(aes(label = round(Ratio_H_M, 1)), vjust = -0.8, size = 3) +
  labs(
    title = "Brecha de g√©nero en el suicidio por edad",
    subtitle = "Ratio de masculinidad: N√∫mero de suicidios masculinos por cada suicidio femenino",
    y = "Ratio (Hombres / Mujeres)",
    x = "Grupo de Edad"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
INTERPRETACI√ìN

Este an√°lisis revela que el suicidio es un fen√≥meno muy masculinizado en todos los grupos de edad (todos los ratios son superiores a 1). Sin embargo, observamos que la brecha no es constante, se dispara en el grupo de 85 a 89 a√±os, donde hay casi 5 hombres por cada mujer.



### Suicidios por sexo a√±os(2021-2023)

```{r , eval = TRUE,message=FALSE}
library(tidyverse)

# Convertimos la columna 'Total' a num√©rico.
# En el CSV los valores vienen con coma decimal ("8,512"), y R necesita punto ("8.512").
provincias$Total <- as.numeric(gsub(",", ".", provincias$Total))

# Filtramos solo:
#  - los tres a√±os que queremos comparar (2021, 2022, 2023)
#  - los datos correspondientes al total nacional
df3 <- provincias %>%
  filter(Periodo %in% c(2021, 2022, 2023),
         Provincias == "Nacional")

# Creamos una gr√°fica de l√≠neas:
#  - Eje X: a√±o
#  - Eje Y: tasa de suicidios por 100.000 habitantes
#  - Color: diferencia entre hombres y mujeres
#  - geom_point: puntos en cada a√±o
#  - geom_line: l√≠nea que une los puntos para cada sexo
ggplot(df3, aes(x = Periodo, y = Total, color = Sexo, group = Sexo)) +
  geom_point(size = 4) +                # Puntos grandes
  geom_line(linewidth = 1.2) +          # L√≠nea gruesa
  theme_bw(base_size = 14) +            # Tema limpio y legible
  labs(title = "Espa√±a: suicidios por sexo (2021‚Äì2023)",
       x = "A√±o",
       y = "Tasa por 100.000 hab.")     # Etiquetas de los ejes


```

INTERPRETACION
La gr√°fica muestra la evoluci√≥n de la tasa de suicidios en Espa√±a entre 2021 y 2023 diferenciando por sexo. Se aprecia claramente que los hombres presentan tasas muy superiores a las de las mujeres en los tres a√±os analizados, con valores aproximadamente tres veces mayores. Adem√°s, las variaciones de un a√±o a otro son peque√±as, lo que indica que la tendencia general se mantiene estable. En conjunto, la gr√°fica evidencia una brecha consistente entre hombres y mujeres, siendo los hombres el grupo con mayor riesgo durante todo el periodo.





# CONCLUSIONES
Tras el an√°lisis comparativo de las tasas de suicidio en Espa√±a utilizando datos oficiales del INE, podemos extraer las siguientes conclsiones princiaples:
- una linea por grafico
.............



Este an√°lisis de datos destaca la necesidad de estrateg√≠as de prevenci√≥n dirigidas espec√≠ficamente a los grupos de mayor riesgo identificados: hombres y....

# REFERENCIAS 







